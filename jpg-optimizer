#!/usr/bin/env bash

# Defaults
MAX_WIDTH=""
MAX_HEIGHT=""
QUALITY="85"
DIR=""

print_usage() {
  echo "Usage: jpg-optimizer <directory> [--max-width=N] [--max-height=N] [--quality=N]"
  exit 1
}

# --- Parse args -------------------------------------------------------

for arg in "$@"; do
  case "$arg" in
    --max-width=* )
      MAX_WIDTH="${arg#*=}"
      ;;
    --max-width )
      MAX_WIDTH="$2"; shift ;;
    --max-height=* )
      MAX_HEIGHT="${arg#*=}"
      ;;
    --max-height )
      MAX_HEIGHT="$2"; shift ;;
    --quality=* )
      QUALITY="${arg#*=}"
      ;;
    --quality )
      QUALITY="$2"; shift ;;
    -* )
      echo "Unknown option: $arg"
      print_usage
      ;;
    * )
      # directory
      DIR="$arg"
      ;;
  esac
done

# Require directory
if [[ -z "$DIR" ]]; then
  print_usage
fi

if [[ ! -d "$DIR" ]]; then
  echo "Directory not found: $DIR"
  exit 1
fi

# resolve absolute path
if command -v realpath >/dev/null 2>&1; then
  DIR=$(realpath "$DIR")
fi

OUTDIR="$DIR/opt"
mkdir -p "$OUTDIR"

# --- Determine resize string -----------------------------------------

RESIZE=""
if [[ -n "$MAX_WIDTH" || -n "$MAX_HEIGHT" ]]; then
  W="${MAX_WIDTH:-}"
  H="${MAX_HEIGHT:-}"

  # build ImageMagick geometry (e.g. "1200x900>")
  RESIZE="${W}x${H}>"
fi

echo "Input directory: $DIR"
echo "Output directory: $OUTDIR"
echo "Resize: ${RESIZE:-none}"
echo "Quality: $QUALITY"
echo ""

# --- Process PNG and JPG files --------------------------------------

shopt -s nullglob nocaseglob
FILES=("$DIR"/*.png "$DIR"/*.jpg "$DIR"/*.jpeg)

if [[ ${#FILES[@]} -eq 0 ]]; then
  echo "No PNG/JPG files found."
  exit 0
fi

for file in "${FILES[@]}"; do
  base=$(basename "$file")
  name="${base%.*}"

  outfile="$OUTDIR/${name}.jpg"

  echo "Converting: $base â†’ ${name}.jpg"

  if [[ -n "$RESIZE" ]]; then
    magick "$file" -auto-orient -resize "$RESIZE" -quality "$QUALITY" -interlace JPEG "$outfile"
  else
    magick "$file" -auto-orient -quality "$QUALITY" -interlace JPEG "$outfile"
  fi
done

echo ""
echo "Done! Optimized images saved to:"
echo "  $OUTDIR/"
